name: Symbol Tools

on:
  push:
    paths:
      - 'tools/**'
      - 'games/*/src/**'
      - '.github/workflows/symbol-tools.yml'
  pull_request:
    paths:
      - 'tools/**'
      - 'games/*/src/**'
      - '.github/workflows/symbol-tools.yml'

jobs:
  test-tools:
    name: Test Symbol Tools
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install test dependencies
        run: pip install pytest

      - name: Run unit tests
        run: python -m pytest tools/tests/ -v

  check-collisions:
    name: Check Symbol Collisions
    runs-on: ubuntu-latest
    # Only run collision check if games/*/src changed
    # This prevents false positives when only tools change
    if: |
      github.event_name == 'push' ||
      contains(github.event.pull_request.changed_files, 'games/')
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Run collision detection
        run: |
          python tools/detect_collisions.py --output collision_report.txt

      - name: Check for new collisions
        run: |
          # Count collisions (lines that don't start with #)
          COLLISION_COUNT=$(grep -v '^#' collision_report.txt | grep -c . || true)

          echo "Found $COLLISION_COUNT symbol collisions"

          # Store the count for comparison
          # In a real LSC scenario, you'd compare against a known baseline
          # For now, we just report the count

          # After namespacing is complete, uncomment this to fail on ANY collision:
          # if [ "$COLLISION_COUNT" -gt 0 ]; then
          #   echo "ERROR: Symbol collisions detected!"
          #   echo "New symbols need OoT_/MM_ prefixes before merge."
          #   cat collision_report.txt
          #   exit 1
          # fi

          echo "Collision report saved as artifact"

      - name: Upload collision report
        uses: actions/upload-artifact@v4
        with:
          name: symbol-collision-report
          path: collision_report.txt
          retention-days: 30
