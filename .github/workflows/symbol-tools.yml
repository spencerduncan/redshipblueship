name: Symbol Tools

on:
  push:
    paths:
      - 'tools/**'
      - 'games/*/src/**'
      - '.github/workflows/symbol-tools.yml'
  pull_request:
    paths:
      - 'tools/**'
      - 'games/*/src/**'
      - '.github/workflows/symbol-tools.yml'

jobs:
  test-tools:
    name: Test Symbol Tools
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install test dependencies
        run: pip install pytest

      - name: Run unit tests
        run: python -m pytest tools/tests/ -v

  check-collisions:
    name: Check Symbol Collisions
    runs-on: ubuntu-latest
    # Always run when workflow triggers - path filters already handle when to run
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Run collision detection
        run: |
          python tools/detect_collisions.py --output collision_report.txt

      - name: Check for new collisions
        run: |
          # Count collisions (lines that don't start with #)
          COLLISION_COUNT=$(grep -v '^#' collision_report.txt | grep -c . || true)

          echo "Found $COLLISION_COUNT symbol collisions"

          # =================================================================
          # Baseline Strategy (for after LSC completes):
          # =================================================================
          # 1. After namespacing LSC, commit baseline_collisions.txt with
          #    expected collision count (ideally 0)
          # 2. Enable the check below to fail if new collisions are introduced
          # 3. This prevents backsliding - new un-namespaced symbols fail CI
          #
          # To enable after LSC:
          #   - Set EXPECTED_COLLISIONS=0 (or whatever baseline is)
          #   - Uncomment the comparison check
          # =================================================================

          # EXPECTED_COLLISIONS=0  # Set after LSC completes
          # if [ "$COLLISION_COUNT" -gt "$EXPECTED_COLLISIONS" ]; then
          #   echo "ERROR: New symbol collisions detected!"
          #   echo "Expected: $EXPECTED_COLLISIONS, Found: $COLLISION_COUNT"
          #   echo "New symbols need OoT_/MM_ prefixes before merge."
          #   cat collision_report.txt
          #   exit 1
          # fi

          echo "Collision report saved as artifact"

      - name: Upload collision report
        uses: actions/upload-artifact@v4
        with:
          name: symbol-collision-report
          path: collision_report.txt
          retention-days: 30
